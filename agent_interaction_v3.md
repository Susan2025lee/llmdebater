# Agent Interaction Flow: V3 Multi-Round Debate

This describes the conceptual flow for the `OrchestratorV3` workflow, focusing on the interaction for a single initial question generated by the `QuestionAgent`.

**Constraint:** Output yielded to the UI (`streamlit_app_v2.py`) MUST be flattened `(speaker, message)` tuples.

```mermaid
sequenceDiagram
    participant UI as StreamlitAppV2
    participant O3 as OrchestratorV3
    participant QA as QuestionAgent
    participant AA1 as AnswerAgentV3_1
    participant AA2 as AnswerAgentV3_2
    participant LLM as LLMInterface

    Note over UI, O3: Start V3 Workflow (via Button)
    O3 ->> QA: generate_questions(q_doc_path, num_q)
    activate QA
    QA ->> LLM: Generate questions prompt
    activate LLM
    LLM -->> QA: Initial Questions List
    deactivate LLM
    QA -->> O3: [Q1, Q2, ...]
    deactivate QA
    UI <<-- O3: yield (Sys, "Generated questions...")
    UI <<-- O3: yield (QA, "Generated X questions.")

    loop For Each Question q in [Q1, Q2, ...]
        UI <<-- O3: yield (Sys, "-- Starting Debate for Q --")
        UI <<-- O3: yield (QA, q)
        O3 ->> O3: Initialize debate_history = []
        
        UI <<-- O3: yield (Sys, "-- Gathering Initial Answers --")
        
        par Get Initial Answer 1
            O3 ->> AA1: ask_question(q, doc1_path)
            activate AA1
            AA1 ->> LLM: Answer prompt for q based on doc1
            activate LLM
            LLM -->> AA1: Answer A1_R0
            deactivate LLM
            AA1 -->> O3: A1_R0
            deactivate AA1
            O3 ->> O3: Add (AA1, R0, A1_R0) to history
            UI <<-- O3: yield (AA1, "Initial Answer: A1_R0")
        and Get Initial Answer 2
            O3 ->> AA2: ask_question(q, doc2_path)
            activate AA2
            AA2 ->> LLM: Answer prompt for q based on doc2
            activate LLM
            LLM -->> AA2: Answer A2_R0
            deactivate LLM
            AA2 -->> O3: A2_R0
            deactivate AA2
            O3 ->> O3: Add (AA2, R0, A2_R0) to history
            UI <<-- O3: yield (AA2, "Initial Answer: A2_R0")
        end

        loop For Round R from 1 to max_debate_rounds
            UI <<-- O3: yield (Sys, "-- Starting Debate Round R --")
            O3 ->> O3: current_round_responses = []
            
            par Participate Round R - Agent 1
                O3 ->> AA1: participate_in_debate(q, history, doc1_path)
                activate AA1
                AA1 ->> LLM: Debate prompt (q, history, doc1)
                activate LLM
                LLM -->> AA1: Response A1_R
                deactivate LLM
                AA1 -->> O3: A1_R
                deactivate AA1
                O3 ->> O3: Add (AA1, R, A1_R) to current_round_responses
                UI <<-- O3: yield (AA1, "Round R: A1_R")
            and Participate Round R - Agent 2
                O3 ->> AA2: participate_in_debate(q, history, doc2_path)
                activate AA2
                AA2 ->> LLM: Debate prompt (q, history, doc2)
                activate LLM
                LLM -->> AA2: Response A2_R
                deactivate LLM
                AA2 -->> O3: A2_R
                deactivate AA2
                O3 ->> O3: Add (AA2, R, A2_R) to current_round_responses
                UI <<-- O3: yield (AA2, "Round R: A2_R")
            end
            O3 ->> O3: Add current_round_responses to history
        end

        UI <<-- O3: yield (Sys, "-- Synthesizing Final Answer --")
        O3 ->> LLM: Synthesis prompt (q, full history)
        activate LLM
        LLM -->> O3: Final_Answer
        deactivate LLM
        UI <<-- O3: yield (Synthesizer, Final_Answer)
        O3 ->> O3: write_output(q, Final_Answer)
        UI <<-- O3: yield (Sys, "Synthesis complete.")

    end
    UI <<-- O3: yield (Sys, "--- V3 Debate Workflow Complete ---")

```

**Key Flow Points:**

1.  **Initial Questions:** `QuestionAgent` generates questions based on the question document.
2.  **Round 0 (Initial Answers):** Each `AnswerAgentV3` provides an initial answer using `ask_question` based only on its own document.
3.  **Debate Rounds (1 to N):**
    *   `OrchestratorV3` passes the original question and the **accumulated `debate_history`** to each `AnswerAgentV3`.
    *   Each `AnswerAgentV3` uses its `participate_in_debate` method (with a specific debate prompt) to generate its response for the round.
    *   `OrchestratorV3` collects responses and adds them to the `debate_history` for the *next* round.
4.  **Synthesis:** After the debate rounds, `OrchestratorV3` passes the original question and the **complete `debate_history`** to the LLM via a synthesis prompt to get the final answer.
5.  **Output:** The final Question/Answer pair is written to the output file. All intermediate steps (questions, initial answers, round responses, synthesis messages) are yielded as `(speaker, message)` tuples for the V2 UI. 